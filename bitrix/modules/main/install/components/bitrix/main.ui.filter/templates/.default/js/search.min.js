(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Search=function(t){this.parent=null;this.container=null;this.input=null;this.preset=null;this.buttonsContainer=null;this.init(t)};BX.Filter.Search.prototype={init:function(t){this.parent=t;BX.bind(this.getInput(),"input",BX.delegate(this._onInputWithoutDebounce,this));if(this.parent.getParam("ENABLE_LIVE_SEARCH")){BX.bind(this.getInput(),"input",BX.debounce(this._onInput,250,this))}BX.bind(this.getInput(),"keydown",BX.delegate(this._onKeyDown,this));BX.bind(this.getFindButton(),"click",BX.delegate(this._onSearchClick,this));this.firstInit=true},getFindButton:function(){if(!BX.type.isDomNode(this.findButton)){this.findButton=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButton)}return this.findButton},_onSearchClick:function(){this.parent.applyFilter(null,true)},getCode:function(t){var e="";if("code"in t&&t.code){e=t.code}else if("keyCode"in t&&t.keyCode){var i=t.keyCode;var s={27:"Escape",9:"Tab",40:"ArrowDown",38:"ArrowUp",8:"Backspace",13:"Enter",65:"KeyA"};e=i in s?s[i]:""}return e},_onKeyDown:function(t){var e=BX.Filter.Utils.getByClass(t.target.parentNode,this.parent.settings.classSquare,true);var i;if(this.getCode(t)==="Enter"){this.parent.applyFilter(null,true);if(this.parent.getPopup().isShown()){this.parent.closePopup()}this.isAllSelected=false}else if(this.getCode(t)==="Tab"||this.getCode(t)==="ArrowDown"){if(!this.parent.getPopup().isShown()){this.parent.showPopup();this.parent.adjustFocus()}if(this.isAllSelected){e.forEach(function(t){BX.removeClass(t,this.parent.settings.classSquareSelected)},this)}this.isAllSelected=false}else if(this.getCode(t)==="ArrowUp"){if(this.parent.getPopup().isShown()){this.parent.closePopup();if(this.parent.getParam("VALUE_REQUIRED_MODE")){this.parent.restoreRemovedPreset()}}this.isAllSelected=false}else if(this.getCode(t)==="KeyA"&&t.metaKey||this.getCode(t)==="KeyA"&&t.ctrlKey){if(BX.type.isArray(e)){e.forEach(function(t){BX.addClass(t,this.parent.settings.classSquareSelected)},this)}this.isAllSelected=true}else if(this.getCode(t)==="Backspace"&&t.currentTarget.selectionStart===0&&this.isAllSelected){this.parent.resetFilter();this.isAllSelected=false}else if(this.getCode(t)==="Backspace"&&t.currentTarget.selectionStart===0&&t.currentTarget.selectionEnd===0&&!this.isAllSelected){e=BX.type.isArray(e)&&e.length?e[e.length-1]:null;if(BX.type.isDomNode(e)){if(BX.hasClass(e,this.parent.settings.classSquareSelected)){i=BX.Filter.Utils.getByClass(e,this.parent.settings.classSquareDelete);if(BX.type.isDomNode(i)){BX.fireEvent(i,"click")}}else{BX.addClass(e,this.parent.settings.classSquareSelected)}}}else if(BX.type.isArray(e)&&e.length&&t.key!=="Meta"&&t.key!=="CapsLock"&&t.key!=="Shift"&&t.key!=="Alt"&&t.key!=="Escape"&&t.key!=="F1"&&t.key!=="F2"&&t.key!=="F3"&&t.key!=="F4"&&t.key!=="F5"&&t.key!=="F6"&&t.key!=="F7"&&t.key!=="F8"&&t.key!=="F9"&&t.key!=="F10"&&t.key!=="F11"&&t.key!=="F12"){e.forEach(function(t){BX.removeClass(t,this.parent.settings.classSquareSelected)},this)}},getSearchString:function(t){return t&&(t.currentTarget||t.target)?(t.currentTarget||t.target).value:""},getSquares:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,true)},adjustPlaceholder:function(){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"+(this.parent.getParam("DISABLE_SEARCH")?"":"_DEFAULT")))},_onInputWithoutDebounce:function(t){var e=this.getSearchString(t);if(e!=this.lastSearchString&&(!BX.hasClass(document.documentElement,"bx-ie")||!this.firstInit)){if(this.parent.getParam("ENABLE_LIVE_SEARCH")){this.parent.grid&&this.parent.grid.tableFade()}this.parent.getPopup().isShown()&&this.parent.closePopup()}if(e){this.showClearButton()}else{if(!this.getSquares().length&&this.lastSearchString!==e){this.hideClearButton();this.adjustPlaceholder()}}this.lastSearchString=e},_onInput:function(t){var e=this.parent;var i=this.getSearchString(t);if(!BX.hasClass(document.documentElement,"bx-ie")||!this.firstInit){if(i.length&&this.lastValue!=i){e.applyFilter(null,true);this.lastValue=i;this.isClear=false}else{if(!this.isClear){this.isClear=true;e.applyFilter(true,true)}else{this.parent.grid&&this.parent.grid.tableUnfade()}}}this.firstInit=false},getButtonsContainer:function(){if(!BX.type.isDomNode(this.buttonsContainer)){this.buttonsContainer=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButtonsContainer)}return this.buttonsContainer},showClearButton:function(){BX.addClass(this.getButtonsContainer(),this.parent.settings.classShow)},hideClearButton:function(){BX.removeClass(this.getButtonsContainer(),this.parent.settings.classShow)},getInput:function(){var t;if(!BX.type.isDomNode(this.input)){t=[this.parent.getParam("FILTER_ID",""),"_search"].join("");this.input=BX(t)}return this.input},getContainer:function(){var t;if(!BX.type.isDomNode(this.container)){t=[this.parent.getParam("FILTER_ID"),"_search_container"].join("");this.container=BX(t)}return this.container},setInputPlaceholder:function(t){var e=this.getInput();e.placeholder=t},clearInput:function(){var t=this.getInput();if(BX.type.isDomNode(t)){t.value=null}},clearForm:function(){this.clearInput();this.removePreset()},makeSquares:function(t,e,i){var s;var r=null;var a=this.getContainer();var n={squares:[],moreSquares:[]};t.forEach(function(t,o){if(o<e){s=BX.decl(t);r=r||s;if(!i){if(o===0){BX.prepend(s,a)}else{BX.insertAfter(s,r)}}else{var l=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare);BX.insertAfter(s,l)}r=s;n.squares.push(s)}else{n.moreSquares.push({type:"control",name:t.value,title:t.title})}},this);return n},squares:function(t,e,i){var s,r,a,n,o;var l=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,true);if(i){l.forEach(function(t){var e=BX.data(t,"item");if(e){BX.remove(t)}})}else{l.forEach(BX.remove)}s=this.prepareSquaresData(t);r=this.makeSquares(s,e,i);n=0;o={squaresData:s,width:0};if(r.moreSquares.length){a={block:"main-ui-search-square",name:this.parent.getParam("MAIN_UI_FILTER__AND")+" "+this.parent.getParam("MAIN_UI_FILTER__MORE")+" "+r.moreSquares.length,item:r.moreSquares,title:r.moreSquares.map(function(t){return t.title}).join(", \n")};a=BX.decl(a);r.squares.push(a);BX.insertAfter(a,r.squares[r.squares.length-2]);n=r.squares.reduce(function(t,e){return t+BX.width(e)+(parseFloat(BX.style(e,"margin-right"))||0)},0)}o.width=n;return o},setPreset:function(t){var e=this.getContainer();var i,s;var r;if(BX.type.isPlainObject(t)){s=BX.Filter.Utils.getByClass(e,this.parent.settings.classSquare,true);s.forEach(BX.remove);if(t.ID!=="default_filter"&&t.ID!=="tmp_filter"){i=BX.decl({block:"main-ui-search-square",name:t.TITLE,value:t.ID,isPreset:true});BX.prepend(i,e);if("ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length){r=this.squares(t.ADDITIONAL,1,true);if(BX.width(e)-r.width<100){r=this.squares(t.ADDITIONAL,0,true)}}}else{if(BX.type.isArray(t.FIELDS)&&t.FIELDS.length){r=this.squares(t.FIELDS,2);if(BX.width(e)-r.width<100){r=this.squares(t.FIELDS,1)}}}if(r&&BX.type.isArray(r.squaresData)&&r.squaresData.length||t.ID!=="default_filter"&&t.ID!=="tmp_filter"){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_WITH_FILTER"));this.showClearButton()}else{if(this.parent.getParam("DISABLE_SEARCH")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"))}else{this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"))}}if(BX.type.isNotEmptyString(this.parent.getSearch().getInput().value)){this.showClearButton()}}},prepareSquaresData:function(t){var e,i,s,r;var a=[];t.map(function(t){e=null;switch(t.TYPE){case this.parent.types.DATE:{e=t.LABEL+": "+t.SUB_TYPE.NAME;if(t.SUB_TYPE.VALUE===this.parent.dateTypes.QUARTER&&BX.type.isNotEmptyString(t.VALUES._quarter)){var r=t.QUARTERS.filter(function(e){return e.VALUE==t.VALUES._quarter}).map(function(t){return t.NAME});r=r.length?r.join(""):"";e=t.LABEL+": "+r+" "+this.parent.getParam("MAIN_UI_FILTER__QUARTER").toLocaleLowerCase()+" "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.YEAR&&BX.type.isNotEmptyString(t.VALUES._year)){e=t.LABEL+": "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.MONTH&&BX.type.isNotEmptyString(t.VALUES._month)){var n=t.MONTHS.filter(function(e){return e.VALUE==t.VALUES._month}).map(function(t){return t.NAME});n=n.length?n.join(""):"";e=t.LABEL+": "+n+" "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.EXACT&&BX.type.isNotEmptyString(t.VALUES._from)){e=t.LABEL+": "+t.VALUES._from}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.RANGE){if(BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+t.VALUES._from+"-"+t.VALUES._to}else if(!BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__BEFORE")+" "+t.VALUES._to}else if(BX.type.isNotEmptyString(t.VALUES._from)&&!BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__AFTER")+" "+t.VALUES._from}}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.NONE){e=null}break}case this.parent.types.SELECT:{if(BX.type.isPlainObject(t.VALUE)&&t.VALUE.VALUE){e=t.LABEL+": "+t.VALUE.NAME}break}case this.parent.types.MULTI_SELECT:{if(BX.type.isArray(t.VALUE)&&t.VALUE.length){i=[];e=t.LABEL+": ";t.VALUE.forEach(function(t,e){if(e<2){i.push(t.NAME)}});e+=i.join(", ");if(t.VALUE.length>2){s=[];t.VALUE.forEach(function(t){s.push(t.NAME)});e=s.join(", ")}}break}case this.parent.types.NUMBER:{if(t.SUB_TYPE.VALUE==="exact"){if(BX.type.isNotEmptyString(t.VALUES._from)){e=t.LABEL+": "+t.VALUES._from}else{e=null}}if(t.SUB_TYPE.VALUE==="range"){if(BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+t.VALUES._from+"-"+t.VALUES._to}else if(!BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_LESS")+" "+t.VALUES._to}else if(BX.type.isNotEmptyString(t.VALUES._from)&&!BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_MORE")+" "+t.VALUES._from}else{e=null}}if(t.SUB_TYPE.VALUE==="more"){if(BX.type.isNotEmptyString(t.VALUES._from)){e=t.LABEL+": > ";e+=t.VALUES._from}}if(t.SUB_TYPE.VALUE==="less"){if(BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": < ";e+=t.VALUES._to}}break}case this.parent.types.CUSTOM_ENTITY:{if(BX.type.isNotEmptyString(t.VALUES._value)&&BX.type.isNotEmptyString(t.VALUES._label)){e=t.LABEL+": ";e+=t.VALUES._label}break}case this.parent.types.CUSTOM:{e="_VALUE"in t&&BX.type.isNotEmptyString(t._VALUE)?t.LABEL:null;break}default:{if(BX.type.isNotEmptyString(t.VALUE)){e=t.LABEL+": "+t.VALUE}break}}if(e!==null){a.push({block:"main-ui-search-square",name:e,value:t.NAME,item:{type:"control",name:t.NAME},title:e})}},this);return a},getPreset:function(){var t=this.getContainer();var e=this.parent.settings.classSquare;var i=null;if(BX.type.isDomNode(t)){i=BX.Filter.Utils.getByClass(t,e)}return i},removePreset:function(){var t=this.getPreset();if(BX.type.isDomNode(t)){BX.remove(t);if(this.parent.getParam("DISABLE_SEARCH")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"))}else{this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"))}}this.hideClearButton()},updatePreset:function(t){this.removePreset();this.setPreset(t)}}})();
//# sourceMappingURL=search.map.js