(function(e){function t(t){e._bx_plann_events={};e._bx_plann_mr={};this.id=t.id;this.bOpened=false;this.bMRShowed=false;this.bFreezed=true;this.userId=t.userId;this.accData={};this.accDataMR={};this.accIndex={};this.bAMPM=t.bAMPM;this.DATE_FORMAT=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE"));this.DATETIME_FORMAT=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"));if(this.DATETIME_FORMAT.substr(0,this.DATE_FORMAT.length)==this.DATE_FORMAT)this.TIME_FORMAT=BX.util.trim(this.DATETIME_FORMAT.substr(this.DATE_FORMAT.length));else this.TIME_FORMAT=BX.date.convertBitrixFormat(this.bAMPM?"H:MI:SS T":"HH:MI:SS");this.TIME_FORMAT_SHORT=this.TIME_FORMAT.replace(":s","");this.minWidth=t.minWidth||800;this.minHeight=t.minHeight||300;this.cellWidth=80;this.workTime=t.workTime||[];this.config=t.config||{};this.settings=t.settings||{};this.meetingRooms=t.meetingRooms||false;this.actionUrl=t.actionUrl||"";this.scale=parseInt(this.settings.scale)||1;this.width=parseInt(this.settings.width)||700;this.height=parseInt(this.settings.height)||500;this.pathToUser=t.pathToUser;if(this.width<this.minWidth)this.width=this.minWidth;if(this.height<this.minHeight)this.height=this.minHeight;this.bOnlyWorkTime=true;this.preFetch={back:8,forward:26};this.bAddGroupMembers=!!t.bAddGroupMembers;if(this.bAddGroupMembers){var i=this;this._AddGroupMembers=t.AddGroupMembers;BX.addCustomEvent(e,"onGetGroupMembers",function(e){var t,s=[];for(t in this.Attendees)s.push(this.Attendees[t].User);for(t in e)s.push({id:e[t].id,name:e[t].name});i.SetValues(s)})}if(this.bOnlyWorkTime){var s=this.workTime[0].split("."),n=this.workTime[1].split(".");this.oTime={from:{h:bxIntEx(s[0]),m:bxIntEx(s[1])},to:{h:bxIntEx(n[0]),m:bxIntEx(n[1])}};this.oTime.count=this.oTime.to.h-this.oTime.from.h}else{this.oTime={from:{h:0,m:0},to:{h:24,m:0},count:24}}}t.prototype={Freeze:function(e){this.bFreezed=e;if(e)BX.addClass(this.pCont,"bxecpl-empty");else BX.removeClass(this.pCont,"bxecpl-empty");if(BX.browser.IsIE()){var t=this;setTimeout(function(){t.BuildGridTitle()},1e3)}},OpenDialog:function(e){var t=this;this.curEventId=e.curEventId||false;this.oldLocationMRId=e.oldLocationMRId||false;this.initDate=e.fromDate?BX.parseDate(e.fromDate):new Date;this.accIndex={};this.SetCurrentDate(this.initDate);if(!this.pWnd)this.CreateDialog();this.pWnd.show();if(BX.browser.IsIE())setTimeout(function(){t.BuildGridTitle()},1e3);else this.BuildGridTitle();this.ClearUserList(false);this.pFrom.value=e.fromDate||"";this.pTo.value=e.toDate||"";this.pFromTime.value=e.fromTime||"";this.pToTime.value=e.toTime||"";if(this.config.userTimezoneName){this.pDefTimezoneWrap.style.display="none";this.pDefTimezone.value=this.config.userTimezoneName;this.pFromTz.value=this.pToTz.value=this.config.userTimezoneName}else{this.pDefTimezoneWrap.style.display="";this.pFromTz.value=this.pToTz.value=this.pDefTimezone.value=this.config.userTimezoneDefault||""}if(e.fromTz)this.pFromTz.value=e.fromTz;if(e.toTz)this.pToTz.value=e.toTz;if(e.defaultTz)this.pDefTimezone.value=e.defaultTz;setTimeout(BX.proxy(this.FieldDatesOnChange,this),100);if(parseInt(e.locationMrind)!=e.locationMrind)e.locationMrind=false;this.Location.Set(e.locationMrind,e.location||"");if(e.attendees)this.SetValues(e.attendees);BX.SocNetLogDestination.obItemsSelected[plannerDestFormName]=BX.SocNetLogDestination.getSelected(editEventDestinationFormName);BX("event-planner-dest-item").innerHTML=BX("event-grid-dest-item").innerHTML;this.DestinationOnChange();this.DisplayDiagram(false,true);setTimeout(function(){t.Resize(t.width,t.height);t.oSel.Adjust()},100);this.linkFromToTz=this.pFromTz.value==this.pToTz.value;this.linkFromToDefaultTz=this.pFromTz.value==this.pToTz.value&&this.pFromTz.value==this.pDefTimezone.value;this.bOpened=true},CreateDialog:function(){var e=this;this.pWnd=new BX.PopupWindow("BXCPlanner",null,{overlay:{opacity:10},autoHide:false,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,closeByEsc:true,titleBar:{content:BX.create("span",{html:BXPL_MESS.Planner})},closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButton({text:BXPL_MESS.Next,className:"popup-window-button-accept",events:{click:function(){e.Submit();e.Close(true)}}}),new BX.PopupWindowButtonLink({id:this.id+"bcpl-cancel",text:BXPL_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){e.Close(true)}}}),BX.create("DIV")],content:BX("bx-planner-popup"+this.id),events:{}});BX.addCustomEvent(this.pWnd,"onPopupClose",BX.proxy(this.Close,this));this.BuildCore();this.pDuration=new s(this);this.Location=new BXInputPopup({id:this.id+"loc_2",values:this.meetingRooms,input:BX(this.id+"_planner_location2"),defaultValue:BXPL_MESS.SelectMR,openTitle:BXPL_MESS.OpenMRPage,className:"calendar-inp calendar-inp-time",noMRclassName:"calendar-inp calendar-inp-time"});BX.addCustomEvent(this.Location,"onInputPopupChanged",BX.proxy(this.LocationOnChange,this));this.pResizer=this.pWnd.buttonsContainer.appendChild(BX.create("DIV",{props:{className:"bxec-plan-resizer"},events:{mousedown:BX.proxy(this.ResizerMouseDown,this),drag:BX.False}}));this.pPopupCont=this.pWnd.popupContainer},Close:function(e){if(e===true)this.pWnd.close()},CloseDialog:function(){this.bOpened=false},BuildCore:function(){var t=this.id,s=this;this.pCont=BX(t+"_plan_cont");this.pGridCont=BX(t+"_plan_grid_cont");this.pGridTbl=BX(t+"_plan_grid_tbl");this.pTopCont=BX(t+"_plan_top_cont");if(this.bAMPM)BX.addClass(this.pCont,"bxec-plan-cont-ampm");this.InitDestinationControls();this.pUserListCont=this.pGridTbl.rows[2].cells[0];this.pGridTitleCont=this.pGridTbl.rows[0].cells[2];this.pGridCellCont=this.pGridTbl.rows[2].cells[2];this.pUserListDiv=this.pUserListCont.firstChild;this.pGridTitleDiv=this.pGridTitleCont.firstChild;this.pGridDiv=this.pGridCellCont.firstChild;this.pGAccCont=this.pGridDiv.firstChild;this.pUserListTable=this.pUserListDiv.appendChild(BX.create("TABLE",{props:{className:"bxec-user-list"}}));this.pGridTitleTable=this.pGridTitleDiv.appendChild(BX.create("TABLE",{props:{className:"bxec-grid-cont-tbl"}}));this.pGridTable=this.pGridDiv.appendChild(BX.create("TABLE",{props:{className:"bxec-grid-bg-tbl"}}));if(BX.browser.IsIE())BX.addClass(this.pGridTitleTable,BX.browser.IsDoctype()?"bxec-iehack0":"bxec-iehack");DenyDragEx(this.pGridTable);this.oSel=new i(this);var n;this.pGridDiv.onscroll=function(){s.pGridTitleTable.style.left="-"+parseInt(this.scrollLeft)+"px";s.pUserListTable.style.top="-"+parseInt(this.scrollTop)+"px";if(s.oSel._bScrollMouseDown&&BX.browser.IsIE()){if(n)clearTimeout(n);n=setTimeout(function(){var e=parseInt(s.pGridDiv.scrollLeft);if(!s.oSel||e!=s.oSel._gridScrollLeft)s.GridSetScrollLeft(s.CheckScrollLeft(e));s.oSel._bGridMouseDown=false;s.oSel._bScrollMouseDown=false},1e3)}};this.pScale=BX(t+"_plan_scale_sel");this.pScale.value=this.scale;this.pScale.onchange=function(e){if(s.bFreezed){this.value=s.scale;return BX.PreventDefault(e)}s.ChangeScale(this.value)};this.pFrom=BX(this.id+"planner-from");this.pTo=BX(this.id+"planner-to");this.pFromTime=BX(this.id+"planner_from_time");this.pToTime=BX(this.id+"planner_to_time");this.pFrom.onchange=this.pFromTime.onchange=function(){s.FieldDatesOnChange(true,true)};this.pTo.onchange=this.pToTime.onchange=function(){s.FieldDatesOnChange(true)};this.pFrom.onclick=function(){BX.calendar({node:this.parentNode,field:this,bTime:false})};this.pTo.onclick=function(){BX.calendar({node:this.parentNode,field:this,bTime:false})};this.pFromTime.onclick=e["bxShowClock_"+this.id+"planner_from_time"];this.pToTime.onclick=e["bxShowClock_"+this.id+"planner_to_time"];this.pDefTimezone=BX("planner-tz-def"+this.id);this.pDefTimezoneWrap=BX("planner-tz-def-wrap"+this.id);this.pDefTimezone.onchange=BX.proxy(this.DefaultTimezoneOnChange,this);this.pFromTz=BX("planner-tz-from"+this.id);this.pToTz=BX("planner-tz-to"+this.id);this.pTzOuterCont=BX("planner-tz-cont-outer"+this.id);this.pTzSwitch=BX("planner-tz-switch"+this.id);this.pTzCont=BX("planner-tz-cont"+this.id);this.pTzInnerCont=BX("planner-tz-inner-cont"+this.id);this.pTzSwitch.onclick=BX.proxy(this.TimezoneSwitch,this);this.pFromTz.onchange=BX.proxy(this.TimezoneFromOnChange,this);this.pToTz.onchange=BX.proxy(this.TimezoneToOnChange,this);new BX.CHint({parent:BX("planner-tz-tip"+this.id),hint:BXPL_MESS.eventTzHint});new BX.CHint({parent:BX("planner-tz-def-tip"+this.id),hint:BXPL_MESS.eventTzDefHint})},Submit:function(){var e={fromDate:this.pFrom.value,toDate:this.pTo.value,fromTime:this.pFromTime.value,toTime:this.pToTime.value,locInd:this.curLocationInd,locValue:this.curLocationValue,attendees:this.lastUsers,fromTz:this.pFromTz.value,toTz:this.pToTz.value,defaultTz:this.pDefTimezone.value};BX.onCustomEvent(this,"onSubmit",[e])},CheckSubmit:function(){if(!_this.pFrom.value||!_this.pTo.value){alert(BXPL_MESS.NoFromToErr);return false}if(_this.Attendees.length==0){alert(BXPL_MESS.NoGuestsErr);return false}return true},ChangeScale:function(e){this.scale=parseInt(e,10);while(this.pGridTitleTable.rows[0])this.pGridTitleTable.deleteRow(0);this.BuildGridTitle();this.BuildGrid(this.Attendees.length);this.GetTimelineLimits(true);this.DisplayDiagram(false,true);this.DisplayRoomDiagram(false,true);if(this.oSel.pDiv){this.oSel.Make({bFromTimeLimits:true,bSetTimeline:false});var t=this;setTimeout(function(){t.FieldDatesOnChange(true,true)},500)}BX.userOptions.save("calendar_planner","settings","scale",this.scale)},AddGroupMembers:function(){if(this.bAddGroupMembers&&this._AddGroupMembers&&typeof this._AddGroupMembers=="function")this._AddGroupMembers()},GetAccessibility:function(e){if(!e||!e.length)return;var t=this,i,s,n=this.currentDate,o=new Date,a=new Date;o.setFullYear(n.Y,n.M,n.D-this.preFetch.back);a.setFullYear(n.Y,n.M,n.D+this.preFetch.forward);this.LoadedLimits={from:o.getTime(),to:a.getTime()};i=bxFormatDate(o.getDate(),o.getMonth()+1,o.getFullYear());s=bxFormatDate(a.getDate(),a.getMonth()+1,a.getFullYear());this.Request({postData:this.GetReqData("get_accessibility",{users:e,from:i,to:s,cur_event_id:this.curEventId}),handler:function(e){for(var i in e.data)if(typeof e.data[i]=="object")t.accData[i]=e.data[i];t.DisplayDiagram(false,true);return true}})},CheckAccessibility:function(e){if(e===true){if(this._check_acc_timeout)this._check_acc_timeout=clearTimeout(this._check_acc_timeout);this._check_acc_timeout=setTimeout(BX.proxy(this.CheckAccessibility,this),1500);return}var t=[],i,s;for(i=0;i<this.Attendees.length;i++){s=this.Attendees[i].User.id;if(s&&!this.accIndex[s]){t.push(s);this.accIndex[s]=true}}this.GetAccessibility(t)},GetMRAccessibility:function(e){var t=this,i=this.Location.Get(e),s,n,o=this.currentDate,a=new Date,r=new Date;if(i===false)return;a.setFullYear(o.Y,o.M,o.D-this.preFetch.back);r.setFullYear(o.Y,o.M,o.D+this.preFetch.forward);this.MRLoadedLimits={from:a.getTime(),to:r.getTime()};s=bxFormatDate(a.getDate(),a.getMonth()+1,a.getFullYear());n=bxFormatDate(r.getDate(),r.getMonth()+1,r.getFullYear());this.Request({postData:this.GetReqData("get_mr_accessibility",{id:i,from:s,to:n,cur_event_id:this.oldLocationMRId}),handler:function(e){if(typeof e.data=="object")t.accDataMR[i]=e.data;t.DisplayRoomDiagram(t.accDataMR[i],true)}})},DisplayDiagram:function(e,t){var i;if(t){var s;for(i=this.pGAccCont.childNodes.length;i>0;i--){s=this.pGAccCont.childNodes[i-1];if(s.getAttribute("data-bx-plan-type")=="user")this.pGAccCont.removeChild(s)}}if(!e)e=this.accData;this.arACC=[];var n;for(i=0;i<this.Attendees.length;i++){n=this.Attendees[i].User.key||this.Attendees[i].User.USER_ID;if(e[n])this.DisplayAccRow({ind:i,events:e[n],uid:n})}if(this.oSel)this.oSel.TimeoutCheck(false)},DisplayRoomDiagram:function(e,t){if(!this.bMRShowed)return;this.CleanMRDiagram();this.arMRACC=[];var i=this.Location.Get();if(!e&&i!==false&&this.accDataMR[i])e=this.accDataMR[i];if(!e)e={};this.DisplayAccRow({events:e,ind:this.Attendees.length+2,bMR:true})},CleanMRDiagram:function(){if(typeof this.arMRACC=="object"){var e=BX.findChildren(this.pGAccCont,{attr:{"data-bx-plan-type":"meeting_room"}});for(var t in e)this.pGAccCont.removeChild(e[t])}this.arMRACC=[]},DisplayDiagramEx:function(){var e=this.GetTimelineLimits();if(!this.LoadedLimits||!e)return;if(e.from.getTime()<this.LoadedLimits.from||e.to.getTime()>this.LoadedLimits.to)this.GetAccessibility(this.AttendeesIds);else this.DisplayDiagram(false,true);if(this.bMRShowed&&(e.from.getTime()<this.MRLoadedLimits.from||e.to.getTime()>this.MRLoadedLimits.to))this.GetMRAccessibility();else this.DisplayRoomDiagram(false,true)},DisplayAccRow:function(e){if(typeof e.events!="object")return false;var t=this.GetTimelineLimits(),i=t.from.getTime(),s=t.to.getTime(),n=e.ind*20+0+"px",o,a,r,l,h,u,c,p,d,f,m,T,D,v=864e5,g=this.oTime.from.h+this.oTime.from.m/60,M=this.oTime.to.h+this.oTime.to.m/60,b=this.GetDayCellWidth(),B,C,S,X;for(X=0;X<e.events.length;X++){o=e.events[X];if(!o.FROM&&o.DT_FROM_TS)o.FROM=parseInt(o.DT_FROM_TS);if(!o.TO&&o.DT_TO_TS)o.TO=parseInt(o.DT_TO_TS);T=p=o.FROM;D=d=o.TO;f=m=false;if(d<i||p>s)continue;if(p<i){p=i;f=new Date(T)}if(d>s){d=s;m=new Date(D)}a=new Date(p);r=new Date(d);C=b*Math.floor((p-i)/v);var y=a.getHours()+a.getMinutes()/60;var _=y-g;if(_>0)C+=Math.round(b*_/this.oTime.count);if(o.FROM==o.TO){B=b-1}else{S=b*Math.floor((d-i)/v);if(this.CheckBTime(r))S+=b;var L=r.getHours()+r.getMinutes()/60;if(L>M)L=M;var I=L-g;if(I>0)S+=Math.round(b*I/this.oTime.count);B=S-C-1}if(B>0){l="bxec-gacc-el";if(!e.bMR&&o.ACCESSIBILITY!="busy")l+=" bxec-gacc-"+o.ACCESSIBILITY;if(!f)f=a;if(!m)m=r;u=zeroInt(f.getHours())+":"+zeroInt(f.getMinutes());c=zeroInt(m.getHours())+":"+zeroInt(m.getMinutes());u=u=="00:00"?"":" "+u;c=c=="00:00"?"":" "+c;h=e.bMR?o.NAME+";\n ":"";h+=BX.util.trim(bxFormatDate(f.getDate(),f.getMonth()+1,f.getFullYear())+" "+this.FormatTimeOld(f.getHours(),f.getMinutes(),true,true))+" - "+BX.util.trim(bxFormatDate(m.getDate(),m.getMonth()+1,m.getFullYear())+" "+this.FormatTimeOld(m.getHours(),m.getMinutes(),true,true));if(!e.bMR){if(o.ACCESSIBILITY)h+=";\n "+BXPL_MESS.UserAccessibility+": "+BXPL_MESS["Acc_"+o.ACCESSIBILITY].toLowerCase();if(o.IMPORTANCE)h+=";\n "+BXPL_MESS.Importance+": "+BXPL_MESS["Importance_"+o.IMPORTANCE].toLowerCase()}if(o.FROM_HR)h+=";\n ("+BXPL_MESS.FromHR+")";var x=this.pGAccCont.appendChild(BX.create("DIV",{props:{className:l,title:h},style:{top:n,left:C+"px",width:B+"px"}}));x.setAttribute("data-bx-plan-type",e.bMR?"meeting_room":"user");if(!u&&!c)d+=v;if(e.bMR)this.arMRACC.push({div:x,from:p,to:d});else this.arACC.push({div:x,from:p,to:d,uid:e.uid,aac:o.ACCESSIBILITY})}}},BlinkDiagramDiv:function(e){var t=0,i=e.className,s="bxec-gacc-el bxec-gacc-warn";if(i!=s){var n=setInterval(function(){e.className=e.className==s?i:s;if(++t>5)clearInterval(n)},250)}},BuildGridTitle:function(){if(this.pGridTitleTable.rows.length>0)BX.cleanNode(this.pGridTitleTable);var e=this.pGridTitleTable.insertRow(-1),t=this.pGridTitleTable.insertRow(-1),i,s,n=this.GetDaysCount(),o,a,r;t.className="bxec-pl-time-row bxecpl-s"+this.scale;e.className="bxec-plan-grid-day-row";this.pGTCells=[];for(a=0;a<n;a++){i=e.insertCell(-1);i.innerHTML='<img src="/bitrix/images/1.gif" class="day-t-left"/><div></div><img src="/bitrix/images/1.gif" class="day-t-right"/>';r={pDay:i,pTitle:i.childNodes[1]};this.SetDayInCell(i,r.pTitle,a);if(this.scale==0)i.colSpan=this.oTime.count*2;else if(this.scale==1)i.colSpan=this.oTime.count;else if(this.scale==2)i.colSpan=Math.ceil(this.oTime.count/2);if(this.scale!=3){for(o=this.oTime.from.h;o<this.oTime.to.h;o++){s=t.insertCell(-1);s.innerHTML="<div>"+this.FormatTimeOld(o,parseInt(this.oTime.from.m),false,false,true)+"</div>";if(this.scale==2)o++;if(this.scale==0){s=t.insertCell(-1);s.className="bxecpl-half-t-cell";if(this.bAMPM)s.innerHTML="<div></div>";else if(parseInt(this.oTime.from.m)==0)s.innerHTML="<div>"+this.FormatTimeOld(o,30)+"</div>";else s.innerHTML="<div>"+this.FormatTimeOld(o+1,0)+"</div>"}}}else{s=t.insertCell(-1);s.innerHTML="<div>"+this.FormatTimeOld(this.oTime.from.h,this.oTime.from.m,false,false,true)+" - "+this.FormatTimeOld(this.oTime.to.h,this.oTime.to.m,false,false,true)+"</div>";r.pTime=s}this.pGTCells.push(r)}},FormatTimeOld:function(e,t,i,s,n){var o="";if(t==undefined)t="00";else{t=parseInt(t,10);if(isNaN(t))t="00";else{if(t>59)t=59;t=t<10?"0"+t.toString():t.toString()}}e=parseInt(e,10);if(e>24)e=24;if(s===true&&e==0&&t=="00")return"";if(this.bAMPM){var a="am";if(e==0){e=12}else if(e==12){a="pm"}else if(e>12){a="pm";e-=12}if(n&&t.toString()=="00")o=e.toString();else o=e.toString()+":"+t.toString();o+=(i?" ":"")+a}else{o=(e<10?"0":"")+e.toString()+":"+t.toString()}return o},ParseTime:function(e){var t,i,s;e=BX.util.trim(e);e=e.toLowerCase();if(this.bAMPM){var n="pm";if(e.indexOf("am")!=-1)n="am";e=e.replace(/[^\d:]/gi,"");s=e.split(":");t=parseInt(s[0]||0,10);i=parseInt(s[1]||0,10);if(t==12){if(n=="am")t=0;else t=12}else if(t!=0){if(n=="pm"&&t<12){t+=12}}}else{s=e.split(":");t=s[0]||0;i=s[1]||0}return{h:t,m:i}},SetDayInCell:function(e,t,i){var s=i-(this.scale==3?2:1),n=new Date;n.setFullYear(this.currentDate.Y,this.currentDate.M,this.currentDate.D+s);var o=this.ConvertDayIndex(n.getDay()),a=n.getDate(),r=n.getMonth(),l=n.getFullYear(),h=bxFormatDate(a,r+1,l),u=this.currentDate,c=this.config.week_holidays[o]||this.config.year_holidays[a+"."+r],p=a==u.date&&r==u.month&&l==u.year;if(this.scale==3&&BX.message("FORMAT_DATE").indexOf("MMMM")!=-1)h=zeroInt(a)+"."+zeroInt(r+1)+"."+l;if(c&&p)e.className="cur-hol-day";else if(c)e.className="hol-day";else if(p)e.className="cur-day";else e.className="";t.innerHTML=h;e.title=this.config.days[this.ConvertDayIndex(n.getDay())][0]+", "+h},BuildGrid:function(e){var t=this,i=this.pGridTable.rows[0]||this.pGridTable.insertRow(-1),s,n=this.cellWidth+1,o=this.GetDaysCount(),a=e*20;i.className="bxecp-bg-grid-row bxecpl-s"+this.scale;if(this.scale==0)s=(n+1)*this.oTime.count;else if(this.scale==1)s=(n+1)*this.oTime.count/2;else if(this.scale==2)s=(n+1)*this.oTime.count/4;else s=n;if(!this.oneGridDiv)this.oneGridDiv=i.insertCell(-1).appendChild(BX.create("DIV"));this.oneGridDiv.style.width=s*o+"px";if(this.bMRShowed){setTimeout(function(){t.AdjustMRStub(true)},100);a+=60}this.oneGridDiv.style.height=a+"px";setTimeout(function(){t.GridSetScrollLeft(t.CheckScrollLeft(0,false))},100)},CheckScrollLeft:function(e,t){e=parseInt(e);var i;if(this.scale==0)i=this.cellWidth*2*this.oTime.count/2;else if(this.scale==1)i=this.cellWidth*this.oTime.count/2;else if(this.scale==2)i=this.cellWidth*this.oTime.count/4;else i=this.cellWidth*2;var s=Math.abs(parseInt(this.pGridDiv.scrollWidth)-this.gridDivWidth-i);if(e<i){e=i+e;if(t!==false)this.OffsetCurrentDate(-this.GetScrollOffset())}else if(e>s){e=e-i;if(t!==false)this.OffsetCurrentDate(this.GetScrollOffset())}return e},GridSetScrollLeft:function(e){this.pGridTitleTable.style.left="-"+e+"px";this.pGridDiv.scrollLeft=e},OffsetCurrentDate:function(e,t){var i,s,n=this.GetDaysCount(),o=new Date;o.setFullYear(this.currentDate.Y,this.currentDate.M,this.currentDate.D+e);this.SetCurrentDate(o);this.GetTimelineLimits(true);this.DisplayDiagramEx();if(t!==false&&this.oSel.pDiv)this.oSel.Make({bFromTimeLimits:true,bSetTimeline:false});for(s=0;s<n;s++){i=this.pGTCells[s];this.SetDayInCell(i.pDay,i.pTitle,s)}},Resize:function(e,t){if(e<this.minWidth)e=this.minWidth;if(t<this.minHeight)t=this.minHeight;this.width=e;this.height=t;this.pCont.style.width=e-22+"px";this.pCont.style.height=t-70+"px";var i=this.pTopCont.offsetHeight,s=t-i-39-32,n=e-20;this.pGridCont.style.height=s+"px";this.pGridTbl.style.height=s+"px";this.pUserListCont.style.height=s-45+"px";this.pGridCellCont.style.height=s-45+"px";this.gridDivWidth=n-180-5;this.pGridDiv.style.width=n-180-5+"px";this.pGridTitleDiv.style.width=n-180-5+"px"},ResizerMouseDown:function(){this.oPos={top:parseInt(this.pPopupCont.style.top,10),left:parseInt(this.pPopupCont.style.left,10)};BX.bind(document,"mouseup",BX.proxy(this.ResizerMouseUp,this));BX.bind(document,"mousemove",BX.proxy(this.ResizerMouseMove,this))},ResizerMouseUp:function(){BX.unbind(document,"mouseup",BX.proxy(this.ResizerMouseUp,this));BX.unbind(document,"mousemove",BX.proxy(this.ResizerMouseMove,this));this.oSel.Adjust();BX.userOptions.save("calendar_planner","settings","width",this.width);BX.userOptions.save("calendar_planner","settings","height",this.height)},ResizerMouseMove:function(e){var t=BX.GetWindowSize(document),i=e.clientX+t.scrollLeft,s=e.clientY+t.scrollTop,n=i-this.oPos.left,o=s-this.oPos.top;this.Resize(n,o)},SetUsersInfo:function(){},SetCurrentDate:function(e){this.currentDate={oDate:e,Y:e.getFullYear(),M:e.getMonth(),D:e.getDate()}},GetGridCellWidth:function(){return this.scale==3?this.cellWidth+1:this.cellWidth/2+1},GetTimelineLimits:function(e){if(e||!this.TimelineLimits){var t=this.GetScrollOffset(),i=this.currentDate,s=new Date,n=new Date;s.setFullYear(i.Y,i.M,i.D-t);n.setFullYear(i.Y,i.M,i.D+(this.GetDaysCount()-t-1));s.setHours(0,0,0,0);n.setHours(23,59,59,999);this.TimelineLimits={from:s,to:n}}return this.TimelineLimits},GetScrollOffset:function(){return this.scale==3?2:1},GetDaysCount:function(){if(this.scale==2)return 15;if(this.scale==3)return 30;return 10},GetDayCellWidth:function(){var e=this.oTime.count,t=this.GetGridCellWidth();switch(parseInt(this.scale)){case 0:return t*e*2;case 1:return t*e;case 2:return Math.ceil(t*e/2);case 3:return t}},SetFields:function(e){var t=e.from,i=e.to,s=this.FormatTimeOld(t.getHours(),t.getMinutes(),true,true),n=this.FormatTimeOld(i.getHours(),i.getMinutes(),true,true);if(!t||isNaN(t.getDate())||!i||isNaN(i.getDate()))return;this.oSel.curSelFT={from:t,to:i};if(t&&i){this.pFrom.value=bxFormatDate(t.getDate(),t.getMonth()+1,t.getFullYear());this.pTo.value=bxFormatDate(i.getDate(),i.getMonth()+1,i.getFullYear());this.pFromTime.value=s;this.pToTime.value=n;this.pDuration.Set(i.getTime()-t.getTime())}else{this.pFrom.value=this.pTo.value=this.pFromTime.value=this.pToTime.value=""}},GetFieldDate:function(e){var t=BX.parseDate(e=="from"?this.pFrom.value:this.pTo.value);if(t){var i=this.ParseTime(e=="from"?this.pFromTime.value:this.pToTime.value);t.setHours(i.h);t.setMinutes(i.m)}return t},FieldDatesOnChange:function(e,t){if(this.bFreezed)return false;if(t&&this.oSel)this.bFocusSelection=true;if(t&&!isNaN(parseInt(this.pDuration.pInp.value)))return this.pDuration.OnChange();var i=this.ParseDate(BX.util.trim(this.pFrom.value)+" "+BX.util.trim(this.pFromTime.value)),s=this.ParseDate(BX.util.trim(this.pTo.value)+" "+BX.util.trim(this.pToTime.value));if(i&&s){if(e!==false)this.pDuration.Set(s.getTime()-i.getTime());this.oSel.Make({bFromTimeLimits:true,from:i,to:s,bSetFields:false})}else{this.oSel.Hide()}},CheckBTime:function(e){return e.getHours()==0&&e.getMinutes()==0},ReColourTable:function(){var e,t=this.pUserListTable.rows.length;if(this.bMRShowed){t-=2;this.MRControll.pLoc.className=t/2==Math.round(t/2)?"":"bx-grey"}for(e=0;e<t;e++)this.pUserListTable.rows[e].className=e/2==Math.round(e/2)?"":"bx-grey"},LocationOnChange:function(e,t,i){this.curLocationInd=t;this.curLocationValue=i;if(t===false){this.ShowMRControll(false)}else{this.AddMR(t);this.ShowMRControll()}},AddMR:function(e){if(!this.meetingRooms)return;var t=this,i=this.meetingRooms[e];if(!i)return;if(!this.MRControll){var s=this.pUserListTable.insertRow(-1),n=s.insertCell(-1);s.className="bxec-mr-title";n.innerHTML="<b>"+BXPL_MESS.Location+"</b>";var o=this.pUserListTable.insertRow(-1),a=o.insertCell(-1);a.onmouseover=function(){this.className="bxex-pl-u-over"};a.onmouseout=function(){this.className=""};var r=this.pGridDiv.appendChild(BX.create("DIV",{props:{className:"bxecpl-mr-stub"}}));this.MRControll={pTitle:s,pLoc:o,pLocName:a,stub:r}}this.MRControll.pLocName.innerHTML="<div>"+(i.URL?'<a href="'+i.URL+'" target="_blank">'+BX.util.htmlspecialchars(i.NAME)+"</a>":BX.util.htmlspecialchars(i.NAME))+"</div>";var l=this.MRControll.pLocName.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",title:BXPL_MESS.FreeMR,className:"bxecp-del"}}));l.onclick=function(){t.Location.Set(false,"")};this.MRControll.pLoc.title=i.NAME;this.GetMRAccessibility(e)},ShowMRControll:function(e){var t="none",i=this.Attendees.length||0,s=i*20;e=e!==false;this.bMRShowed=e;if(e){s+=60;t=""}else{this.CleanMRDiagram()}if(this.oneGridDiv)this.oneGridDiv.style.height=s+"px";this.oSel.Adjust();if(this.MRControll){this.AdjustMRStub(e);this.MRControll.pLoc.className=i/2==Math.round(i/2)?"":"bx-grey";this.MRControll.pTitle.style.display=this.MRControll.pLoc.style.display=t;this.MRControll.pTitle.className="bxec-mr-title"}},AdjustMRStub:function(e){if(this.MRControll&&this.MRControll.stub){this.MRControll.stub.style.display=e?"block":"none";if(e){var t=parseInt(this.pGridTable.offsetWidth)-1;if(isNaN(t)||t<=0){var i=this;return setTimeout(function(){i.AdjustMRStub(e)},100)}this.MRControll.stub.style.top=parseInt(this.Attendees.length)*20+"px";this.MRControll.stub.style.width=parseInt(this.pGridTable.offsetWidth)-1+"px"}}},GetScrollBarSize:function(){if(!this._sbs){var e=this.pPopupCont.appendChild(BX.create("DIV",{props:{className:"bxex-sbs"},html:"&nbsp;"}));this._sbs=e.offsetWidth-e.clientWidth;setTimeout(function(){e.parentNode.removeChild(e)},50)}return this._sbs||20},ConvertDayIndex:function(e){if(e==0)return 6;return e-1},GetReqData:function(e,t){if(!t)t={};if(e)t.action=e;t.sessid=BX.bitrix_sessid();t.bx_event_calendar_request="Y";t.reqId=Math.round(Math.random()*1e6);return t},Request:function(e){if(!e.url)e.url=this.actionUrl;if(e.bIter!==false)e.bIter=true;if(!e.postData&&!e.getData)e.getData=this.GetReqData();var t=this,i=0,s=e.getData?e.getData.reqId:e.postData.reqId;var n=function(n){var o=function(){BX.closeWait(t.pPopupCont);var a=e.handler(t.GetRequestRes(s),n);if(a===false&&++i<20&&e.bIter)setTimeout(o,5);else t.ClearRequestRes(s)};setTimeout(o,20)};BX.showWait(this.pPopupCont);if(e.postData)BX.ajax.post(e.url,e.postData,n);else BX.ajax.get(e.url,e.getData,n);return s},GetRequestRes:function(e){if(top.BXCRES&&typeof top.BXCRES[e]!="undefined")return top.BXCRES[e];return{}},ClearRequestRes:function(e){if(top.BXCRES){top.BXCRES[e]=null;delete top.BXCRES[e]}},InitUserControll:function(e){var t=this;this.pCount=BX(this.id+"pl-count");return},SetValues:function(e){var t,i=e.length,s;for(t=0;t<i;t++){s=e[t];s.key=s.id||s.email;if(s&&s.key&&!this.oAttendees[s.key])this.DisplayAttendee(s)}this.UpdateCount()},UpdateCount:function(){this.BuildGrid(this.count);this.ReColourTable();this.oSel.Adjust();if(this.count==0){this.pCount.innerHTML="";this.Freeze(true)}else{this.pCount.innerHTML=" ("+this.count+")";this.Freeze(false);this.CheckAccessibility(true)}},DisplayAttendee:function(e){var t=e.DISPLAY_NAME||e.name,i=parseInt(e.USER_ID||e.id);if(i&&!this.oAttendees[i]){this.count++;var s=this.pUserListTable.insertRow(this.count-1);s.id="ec_pl_u_"+i;var n=s.insertCell(-1);n.innerHTML='<span class="bxec-user-name">'+BX.util.htmlspecialchars(t)+"</span>";this.oAttendees[i]={User:e,pRow:s,ind:this.Attendees.length};this.Attendees.push(this.oAttendees[i]);if(i>0)this.AttendeesIds.push(i)}},ClearUserList:function(e){if(e!==false&&!confirm(BXPL_MESS.DelAllGuestsConf))return;var t=true,i=0;while(i<this.pUserListTable.rows.length){t=this.pUserListTable.rows[i];if(t&&~t.id.indexOf("ec_pl_u_"))t.parentNode.removeChild(t);else i++}this.count=0;this.oAttendees={};var s=[];this.Attendees=[];this.AttendeesIds=[];this.UpdateCount();this.DisplayDiagram(false,true);this.DisplayRoomDiagram(false);var n,o=this.Attendees.length;for(n=0;n<o;n++){if(this.Attendees[n].id==id){if(this.Attendees[n].bDel===false){if(confirm(BXPL_MESS.DelOwnerConfirm))this.DelAllGuests();return true}pRow.parentNode.removeChild(pRow);this.Attendees=BX.util.deleteFromArray(this.Attendees,n);break}}},InitDestinationControls:function(){BX.addCustomEvent("OnDestinationAddNewItemPlanner",BX.proxy(this.DestinationOnChange,this));BX.addCustomEvent("OnDestinationUnselectPlanner",BX.proxy(this.DestinationOnChange,this));this.pDestValuesCont=BX("event-planner-dest-item");this.pCount=BX(this.id+"pl-count");BX.bind(this.pDestValuesCont,"click",function(e){var t=e.target||e.srcElement;if(t.className=="feed-event-del-but"){BX.SocNetLogDestination.deleteItem(t.getAttribute("data-item-id"),t.getAttribute("data-item-type"),plannerDestFormName);BX.PreventDefault(e)}});BX.bind(this.pDestValuesCont,"mouseover",function(e){var t=e.target||e.srcElement;if(t.className=="feed-event-del-but")BX.addClass(t.parentNode,"event-grid-dest-hover")});BX.bind(this.pDestValuesCont,"mouseout",function(e){var t=e.target||e.srcElement;if(t.className=="feed-event-del-but")BX.removeClass(t.parentNode,"event-grid-dest-hover")});BxPlannerSetLinkName(e.plannerDestFormName);BX.bind(BX("event-planner-dest-input"),"keyup",BxPlannerSearch);BX.bind(BX("event-planner-dest-input"),"keydown",BxPlannerSearchBefore);BX.bind(BX("event-planner-dest-add-link"),"click",function(e){BX.SocNetLogDestination.openDialog(plannerDestFormName);BX.PreventDefault(e)});BX.bind(BX("event-planner-dest-cont"),"click",function(e){BX.SocNetLogDestination.openDialog(plannerDestFormName);BX.PreventDefault(e)})},DestinationOnChange:function(){var e=this,t,i=this.pDestValuesCont.getElementsByTagName("INPUT"),s,n=["U"+this.userId],o,a,r=this.currentDate,l=new Date,h=new Date;for(s=0;s<i.length;s++)n.push(i[s].value);l.setFullYear(r.Y,r.M,r.D-this.preFetch.back);h.setFullYear(r.Y,r.M,r.D+this.preFetch.forward);this.LoadedLimits={from:l.getTime(),to:h.getTime()};t=this.Request({getData:this.GetReqData("get_attendees_by_codes_planner",{codes:n,path_to_user:this.pathToUser,date_from:BX.date.format(this.DATE_FORMAT,l.getTime()/1e3),date_to:BX.date.format(this.DATE_FORMAT,h.getTime()/1e3),cur_event_id:this.curEventId}),handler:function(i){if(t==e.lastReqId){e.HandleLoadedAccessibility(i.accessibility);e.DisplayAttendees(i.users);e.DisplayDiagram(false,true);e.lastUsers=i.users}}});this.lastReqId=t;setTimeout(function(){e.Resize(e.width,e.height);e.oSel.Adjust()},1)},DisplayAttendees:function(e){this.ClearUserList(false);if(e&&e.length>0){for(var t in e){this.DisplayAttendee(e[t])}}this.UpdateCount();this.DisplayRoomDiagram(false)},TimezoneSwitch:function(){if(this.pTzCont.offsetHeight>0){this.pTzCont.style.height=0;BX.removeClass(this.pTzOuterCont,"bxec-timezone-outer-wrap-opened")}else{this.pTzCont.style.height=this.pTzInnerCont.offsetHeight+"px";BX.addClass(this.pTzOuterCont,"bxec-timezone-outer-wrap-opened")}var e=this;setTimeout(function(){e.Resize(e.width,e.height);e.oSel.Adjust()},1);setTimeout(function(){e.Resize(e.width,e.height);e.oSel.Adjust()},100);setTimeout(function(){e.Resize(e.width,e.height);e.oSel.Adjust()},300);setTimeout(function(){e.Resize(e.width,e.height);e.oSel.Adjust()},1e3)},DefaultTimezoneOnChange:function(){var e=this.pDefTimezone.value;BX.userOptions.save("calendar","timezone_name","timezone_name",e);if(this.linkFromToDefaultTz)this.pToTz.value=this.pFromTz.value=this.pDefTimezone.value},TimezoneFromOnChange:function(){if(this.linkFromToTz)this.pToTz.value=this.pFromTz.value;this.linkFromToDefaultTz=false},TimezoneToOnChange:function(){this.linkFromToTz=false;this.linkFromToDefaultTz=false},PreHandleEventData:function(e){if(e.DATE_FROM&&e.DATE_TO){e.dateFrom=BX.parseDate(e.DATE_FROM);e.dateTo=BX.parseDate(e.DATE_TO);if(e.dateFrom&&e.dateTo){e.DT_FROM_TS=e.dateFrom.getTime();e.DT_TO_TS=e.dateTo.getTime();if(e.DT_SKIP_TIME!=="Y"){e.DT_FROM_TS-=e["~USER_OFFSET_FROM"]*1e3;e.DT_TO_TS-=e["~USER_OFFSET_TO"]*1e3}}}return e},HandleLoadedAccessibility:function(e){var t,i;if(e){for(i in e){if(e.hasOwnProperty(i)&&e[i].length>0){this.accIndex[i]=true;this.accData[i]=[];for(t=0;t<e[i].length;t++){this.accData[i][t]=this.PreHandleEventData(e[i][t])}}}}},FormatDate:function(e){return BX.date.format(this.DATE_FORMAT,e.getTime()/1e3)},FormatTime:function(e,t){return BX.date.format(t===true?this.TIME_FORMAT:this.TIME_FORMAT_SHORT,e.getTime()/1e3)},FormatDateTime:function(e){return BX.date.format(this.DATETIME_FORMAT,e.getTime()/1e3);

},ParseDate:function(e,t){var i=false;var s=BX.message("FORMAT_DATETIME");e=BX.util.trim(e);if(t!==false)s=s.replace(":SS","");if(BX.type.isNotEmptyString(e)){var n="";for(l=1;l<=12;l++){n=n+"|"+BX.message("MON_"+l)}var o=new RegExp("([0-9]+|[a-z]+"+n+")","ig");var a=e.match(o),r=BX.message("FORMAT_DATE").match(/(DD|MI|MMMM|MM|M|YYYY)/gi),l,h,u=[],c=[],p={};if(!a)return null;if(a.length>r.length){r=s.match(/(DD|MI|MMMM|MM|M|YYYY|HH|H|SS|TT|T|GG|G)/gi)}for(l=0,h=a.length;l<h;l++){if(BX.util.trim(a[l])!=""){u[u.length]=a[l]}}for(l=0,h=r.length;l<h;l++){if(BX.util.trim(r[l])!=""){c[c.length]=r[l]}}var d=BX.util.array_search("MMMM",c);if(d>0){u[d]=BX.getNumMonth(u[d]);c[d]="MM"}else{d=BX.util.array_search("M",c);if(d>0){u[d]=BX.getNumMonth(u[d]);c[d]="MM"}}for(l=0,h=c.length;l<h;l++){var f=c[l].toUpperCase();p[f]=f=="T"||f=="TT"?u[l]:parseInt(u[l],10)}if(p["DD"]>0&&p["MM"]>0&&p["YYYY"]>0){var m=new Date;if(i){m.setUTCDate(1);m.setUTCFullYear(p["YYYY"]);m.setUTCMonth(p["MM"]-1);m.setUTCDate(p["DD"]);m.setUTCHours(0,0,0)}else{m.setDate(1);m.setFullYear(p["YYYY"]);m.setMonth(p["MM"]-1);m.setDate(p["DD"]);m.setHours(0,0,0)}if((!isNaN(p["HH"])||!isNaN(p["GG"])||!isNaN(p["H"])||!isNaN(p["G"]))&&!isNaN(p["MI"])){if(!isNaN(p["H"])||!isNaN(p["G"])){var T=(p["T"]||p["TT"]||"am").toUpperCase()=="PM";var D=parseInt(p["H"]||p["G"]||0,10);if(T){p["HH"]=D+(D==12?0:12)}else{p["HH"]=D<12?D:0}}else{p["HH"]=parseInt(p["HH"]||p["GG"]||0,10)}if(isNaN(p["SS"]))p["SS"]=0;if(i){m.setUTCHours(p["HH"],p["MI"],p["SS"])}else{m.setHours(p["HH"],p["MI"],p["SS"])}}return m}}return null}};function i(e){this.oPlanner=e;this.id=this.oPlanner.id;this.pGrid=e.pGridDiv;this.pGrid.onmousedown=BX.proxy(this.MouseDown,this);this.pGrid.onmouseup=BX.proxy(this.MouseUp,this)}i.prototype={Make:function(e){var t,i,s,n=this.oPlanner.GetGridCellWidth(),o,a=e.from,r=e.to;if(!this.pDiv)this.Create();this.pDiv.style.display="block";if(e.bFromTimeLimits){e.bSetTimeline=e.bSetTimeline!==false;s=this.oPlanner.GetTimelineLimits(true);if(!a)a=this.curSelFT.from;if(!r)r=this.curSelFT.to;var l,h,u=a.getTime()<s.from.getTime(),c=r.getTime()>s.to.getTime();if(u||c){if(e.bSetTimeline){if(u)l=Math.round((a.getTime()-s.from.getTime())/864e5)-2;else l=Math.round((a.getTime()-s.to.getTime())/864e5)+5;this.oPlanner.OffsetCurrentDate(l,false)}else{this.Hide()}}s=this.oPlanner.GetTimelineLimits(true);var p=this.oPlanner.GetDayCellWidth(),d=this._GetXByDate({date:a,tl:s,dcw:p}),f=this._GetXByDate({date:r,tl:s,dcw:p});if(this.oPlanner.CheckBTime(r)||d==f)f=f+p;t=d;i=f-d-1;if(i<=0)return false;this.curSelFT={from:a,to:r}}else{if(a>r){o=a;a=r;r=o}t=(a-1)*n;i=r*n-t-1}this.pDiv.style.left=t+"px";this.pDiv.style.width=i+"px";this.Check(this.GetCurrent(),false,e.bSetFields!==false);this.pMover.style.left=Math.round(i/2)-6+"px";if(this.oPlanner.bFocusSelection){this.pGrid.scrollLeft=t-50;this._bScrollMouseDown=true;this.MouseUp()}this.oPlanner.bFocusSelection=false},Hide:function(){if(this.pDiv)this.pDiv.style.display="none"},_GetXByDate:function(e){var t=this.oPlanner.oTime,i=864e5,s=e.tl.from.getTime(),n=e.date.getTime(),o=t.from.h+t.from.m/60,a=e.dcw*Math.floor((n-s)/i),r=e.date.getHours()+e.date.getMinutes()/60,l=r-o;if(l>0)a+=Math.round(e.dcw*l/t.count);return a},Create:function(){this.pDiv=BX(this.id+"_plan_selection");var e=this,t=this.pDiv.childNodes[0],i=this.pDiv.childNodes[1];t.onmousedown=function(t){e.StartTransform({e:t,bLeft:true});return BX.PreventDefault(t)};i.onmousedown=function(t){e.StartTransform({e:t,bLeft:false});return BX.PreventDefault(t)};this.pMover=this.pDiv.childNodes[2];this.pMover.onmousedown=function(t){e.StartTransform({e:t,bMove:true});return BX.PreventDefault(t)};this.bDenied=false;this.curSelFT={};DenyDragEx(t);DenyDragEx(i);DenyDragEx(this.pDiv);this.Adjust()},Adjust:function(){if(!this.pDiv)return;var e=parseInt(this.oPlanner.pGridTable.offsetHeight),t=parseInt(this.oPlanner.pGridCellCont.offsetHeight)-this.oPlanner.GetScrollBarSize();this.pDiv.style.height=Math.max(e,t)-2+"px"},MouseDown:function(e){if(this.MoveParams)return;this._gridScrollLeft=parseInt(this.pGrid.scrollLeft);var t=BX.pos(this.pGrid),i=this.GetMouseXY(e);if(t.top+parseInt(this.pGrid.offsetHeight)-i.y<this.oPlanner.GetScrollBarSize()||t.left+parseInt(this.pGrid.offsetWidth)-i.x<this.oPlanner.GetScrollBarSize()){this._bScrollMouseDown=true;return true}this._bGridMouseDown=true;var s=this.GetOverCellIndex({mousePos:i,grigPos:t});this.grigPos=t;this.curSelection={from:s,to:s};BX.unbind(document,"mousemove",BX.proxy(this.MouseMove,this));BX.bind(document,"mousemove",BX.proxy(this.MouseMove,this));this.Make(this.curSelection)},MouseMove:function(e){if(this.MoveParams){this.Transform({mousePos:this.GetMouseXY(e),grigPos:this.grigPos,MoveParams:this.MoveParams});this.TimeoutCheck(true)}else{var t=this.GetOverCellIndex({mousePos:this.GetMouseXY(e),grigPos:this.grigPos});if(this.curSelection&&t!=this.curSelection.to){this.curSelection.to=t;this.Make(this.curSelection)}}},MouseUp:function(){if(this._bGridMouseDown){BX.unbind(document,"mousemove",BX.proxy(this.MouseMove,this));if(this.MoveParams)this.MoveParams=false;this.Check(this.GetCurrent())}else if(this._bScrollMouseDown){var e=parseInt(this.pGrid.scrollLeft);if(e!=this._gridScrollLeft)this.oPlanner.GridSetScrollLeft(this.oPlanner.CheckScrollLeft(e))}this._bGridMouseDown=false;this._bScrollMouseDown=false},StartTransform:function(e){if(!e.bMove&&this.oPlanner.pDuration.bLocked){this.oPlanner.pDuration.LockerBlink();e.bMoveBySide=!!e.bLeft;e.bLeft=null;e.bMove=true}this.MoveParams=e;this._gridScrollLeft=parseInt(this.pGrid.scrollLeft);this._bGridMouseDown=true;var t=BX.pos(this.pGrid),i=this.GetMouseXY(e.e);if(t.top+parseInt(this.pGrid.offsetHeight)-i.y<this.oPlanner.GetScrollBarSize())return true;this.grigPos=t;this.divCurPar={left:parseInt(this.pDiv.style.left,10),width:parseInt(this.pDiv.style.width,10)};this.curSelection=false;BX.unbind(document,"mousemove",BX.proxy(this.MouseMove,this));BX.bind(document,"mousemove",BX.proxy(this.MouseMove,this))},Transform:function(e){if(!this.pDiv)return false;var t,i;if(e.MoveParams.bLeft){t=parseInt(this.pGrid.scrollLeft)+(e.mousePos.x-e.grigPos.left);if(t<0)t=0;if(t>this.divCurPar.left+this.divCurPar.width-10)t=this.divCurPar.left+this.divCurPar.width-10;i=this.divCurPar.width+this.divCurPar.left-t;this.pDiv.style.left=t+"px";this.pDiv.style.width=i+"px";this.pMover.style.left=Math.round(i/2)-6+"px"}else if(!e.MoveParams.bMove){i=parseInt(this.pGrid.scrollLeft)+(e.mousePos.x-e.grigPos.left)-this.divCurPar.left;if(i<10)i=10;this.pDiv.style.width=i+"px";this.pMover.style.left=Math.round(i/2)-6+"px"}else if(e.MoveParams.bMove){var s=this.divCurPar.width/2,n=e.MoveParams.bMoveBySide;if(n===true)s=0;else if(n===false)s=this.divCurPar.width;t=Math.round(parseInt(this.pGrid.scrollLeft)+(e.mousePos.x-e.grigPos.left)-s);if(t<0)t=0;this.pDiv.style.left=t+"px"}},GetOverCellIndex:function(e){var t=e.grigPos||BX.pos(this.pGrid);return Math.ceil((parseInt(this.pGrid.scrollLeft)+(e.mousePos.x-t.left))/this.oPlanner.GetGridCellWidth())},GetCurrent:function(){if(!this.pDiv)return;var e=this.oPlanner.GetTimelineLimits(),t=this.oPlanner.GetDayCellWidth(),i=parseInt(this.pDiv.style.left,10),s=parseInt(this.pDiv.style.width,10)+.5;return{from:this._GetDateByX({x:i,fromD:e.from,dcw:t}),to:this._GetDateByX({x:i+s,fromD:e.from,dcw:t})}},_GetDateByX:function(e){var t=this.oPlanner.oTime,i=Math.floor(e.x/e.dcw),s=t.count*(e.x-i*e.dcw)/e.dcw,n=Math.floor(s),o=t.from.h+n,a=this.oPlanner.scale==3?10:5,r=Math.round(((s-n)*60+t.from.m)/a)*a,l=new Date,h=e.fromD;l.setFullYear(h.getFullYear(),h.getMonth(),h.getDate()+i);l.setHours(o,r,0,0);return l},Check:function(e,t,i){if(!this.oPlanner.arACC||!this.pDiv)return;var s=false,n,o,a=300800,r=this.oPlanner.arACC,l=e.from.getTime()+1,h=e.to.getTime()-1;this.arBusyGuests={};if(this.oPlanner.bMRShowed&&typeof this.oPlanner.arMRACC=="object")r=r.concat(this.oPlanner.arMRACC);o=r.length;for(n=0;n<o;n++){if(r[n].from+a<h&&r[n].to-a>l){s=true;if(r[n].uid>0)this.arBusyGuests[r[n].uid]=r[n].acc||"busy";if(t!==false)this.oPlanner.BlinkDiagramDiv(r[n].div)}}if(i!==false)this.oPlanner.SetFields(e);this.SetDenied(s)},SetDenied:function(e){if(!this.pDiv||this.bDenied==e)return;this.bDenied=e;if(e)BX.addClass(this.pDiv,"bxecp-sel-deny");else BX.removeClass(this.pDiv,"bxecp-sel-deny")},TimeoutCheck:function(e){if(!this.bTimeoutCheck){var t=this;this.bTimeoutCheck=true;setTimeout(function(){t.Check(t.GetCurrent(),false,e);t.bTimeoutCheck=false},200)}},GetMouseXY:function(t){if(!t)t=e.event;var i=0,s=0;if(t.pageX||t.pageY){i=t.pageX;s=t.pageY}else if(t.clientX||t.clientY){i=t.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft)-document.documentElement.clientLeft;s=t.clientY+(document.documentElement.scrollTop||document.body.scrollTop)-document.documentElement.clientTop}return{x:i,y:s}}};function s(e){this.oPlanner=e;this.id=this.oPlanner.id;var t=this;this.pInp=BX(this.id+"_pl_dur");this.pType=BX(this.id+"_pl_dur_type");this.pLock=BX(this.id+"_pl_dur_lock");this.bLocked=false;this.pLock.onclick=function(){t.Lock()};this.pLock.onmouseover=function(){BX.addClass(this,"icon-hover")};this.pLock.onmouseout=function(){BX.removeClass(this,"icon-hover")};this.pInp.onclick=function(){t.ShowPopup()};this.pType.onchange=this.pInp.onchange=function(){t.OnChange()}}s.prototype={Set:function(e){var t,i,s="min",n=Math.round(e/(1e3*60*5))*5,o=n/60;if(n<=0)return false;if(o==Math.round(o)){n=o;s="hour";t=o/this.oPlanner.oTime.count;i=o/24;if(t==Math.round(t)){s="day";n=t}else if(i==Math.round(i)){s="day";n=i}}this.pInp.value=n;this.pType.value=s},Lock:function(){this.bLocked=!this.bLocked;if(this.blinkInterval)this.blinkInterval=clearInterval(this.blinkInterval);this.pLock.className=this.bLocked?"bxecpl-lock-dur bxecpl-lock-pushed":"bxecpl-lock-dur"},LockerBlink:function(){if(!this.bLocked)return;var e=this,t=this.pLock,i=0,s="bxecpl-lock-dur bxecpl-lock-pushed",n="bxecpl-lock-dur icon-blink";if(this.blinkInterval)this.blinkInterval=clearInterval(this.blinkInterval);if(s!=n){this.blinkInterval=setInterval(function(){t.className=t.className==n?s:n;if(++i>5)e.blinkInterval=clearInterval(e.blinkInterval)},250)}},OnChange:function(){var e,t=this.oPlanner.GetFieldDate("from",false),i=parseInt(this.pInp.value,10),s=this.pType.value;if(isNaN(i)||i<=0)i=1;else if(s=="min")i=Math.max(Math.round(i/5)*5,5);this.pInp.value=i;if(t){if(s=="min")e=i;if(s=="hour")e=i*60;else if(s=="day")e=i*60*24;t.setTime(t.getTime()+e*60*1e3);this.oPlanner.pTo.value=this.oPlanner.FormatDate(t);this.oPlanner.pToTime.value=t.getHours()==0&&t.getMinutes()==0?"":this.oPlanner.FormatTime(t)}this.oPlanner.FieldDatesOnChange(false)},ShowPopup:function(){var t=this;this.pInp.select();if(this.bPopupShowed)return this.ClosePopup();if(!this.Popup)this.CreatePopup();this.Popup.style.display="block";this.bPopupShowed=true;this.oPlanner.bDenyClose=true;this.Popup.style.zIndex=1e3;var i=BX.pos(this.pInp);jsFloatDiv.Show(this.Popup,i.left+2,i.top+22,5,false,false);BX.bind(document,"keypress",e["BXEC_DURDEF_CLOSE_"+this.id]);setTimeout(function(){BX.bind(document,"click",e["BXEC_DURDEF_CLOSE_"+t.id])},1)},ClosePopup:function(){this.Popup.style.display="none";this.bPopupShowed=false;this.oPlanner.bDenyClose=false;jsFloatDiv.Close(this.Popup);BX.unbind(document,"keypress",e["BXEC_DURDEF_CLOSE_"+this.id]);BX.unbind(document,"click",e["BXEC_DURDEF_CLOSE_"+this.id])},CreatePopup:function(){this.arDefValues=[{val:15,type:"min",title:"15 "+BXPL_MESS.DurDefMin},{val:30,type:"min",title:"30 "+BXPL_MESS.DurDefMin},{val:1,type:"hour",title:"1 "+BXPL_MESS.DurDefHour1},{val:2,type:"hour",title:"2 "+BXPL_MESS.DurDefHour2},{val:3,type:"hour",title:"3 "+BXPL_MESS.DurDefHour2},{val:4,type:"hour",title:"4 "+BXPL_MESS.DurDefHour2},{val:1,type:"day",title:"1 "+BXPL_MESS.DurDefDay}];var t=this,i,s,n=this.arDefValues.length;this.Popup=document.body.appendChild(BX.create("DIV",{props:{className:"bxecpl-dur-popup"}}));for(s=0;s<n;s++){i=this.Popup.appendChild(BX.create("DIV",{props:{id:"ecpp_"+s,title:this.arDefValues[s].title},text:this.arDefValues[s].title}));i.onmouseover=function(){this.className="bxecpldur-over"};i.onmouseout=function(){this.className=""};i.onclick=function(){var e=t.arDefValues[this.id.substr("ecpp_".length)];t.pInp.value=e.val;t.pType.value=e.type;t.OnChange();t.ClosePopup()}}e["BXEC_DURDEF_CLOSE_"+this.id]=function(e){t.ClosePopup()}}};e.BxPlannerSetLinkName=function(e){var t=BX("event-planner-dest-add-link");if(t)t.innerHTML=BX.SocNetLogDestination.getSelectedCount(e)>0?BX.message("BX_FPD_LINK_2"):BX.message("BX_FPD_LINK_1")};e.BxPlannerSelectCallback=function(e,t,i){var s=t;prefix="S";if(t=="sonetgroups")prefix="SG";else if(t=="groups"){prefix="UA";s="all-users"}else if(t=="users")prefix="U";else if(t=="department")prefix="DR";BX("event-planner-dest-item").appendChild(BX.create("span",{attrs:{"data-id":e.id},props:{className:"event-grid-dest event-grid-dest-"+s},children:[BX.create("input",{attrs:{type:"hidden",name:"EVENT_DESTINATION["+prefix+"][]",value:e.id}}),BX.create("span",{props:{className:"event-grid-dest-text"},html:e.name}),BX.create("span",{props:{className:"feed-event-del-but"},attrs:{"data-item-id":e.id,"data-item-type":t}})]}));BX.onCustomEvent("OnDestinationAddNewItemPlanner",[e]);BX("event-planner-dest-input").value="";BxPlannerSetLinkName(plannerDestFormName)};e.BxPlannerUnSelectCallback=function(e,t,i){var s=BX.findChildren(BX("event-planner-dest-item"),{attribute:{"data-id":""+e.id+""}},true);if(s!=null){for(var n=0;n<s.length;n++)BX.remove(s[n])}BX.onCustomEvent("OnDestinationUnselectPlanner");BX("event-planner-dest-input").value="";BxPlannerSetLinkName(plannerDestFormName)};e.BxPlannerOpenDialogCallback=function(){BX.style(BX("event-planner-dest-input-box"),"display","inline-block");BX.style(BX("event-planner-dest-add-link"),"display","none");BX.focus(BX("event-planner-dest-input"))};e.BxPlannerCloseDialogCallback=function(){if(!BX.SocNetLogDestination.isOpenSearch()&&BX("event-planner-dest-input").value.length<=0){BX.style(BX("event-planner-dest-input-box"),"display","none");BX.style(BX("event-planner-dest-add-link"),"display","inline-block");BxPlannerDisableBackspace()}};e.BxPlannerCloseSearchCallback=function(){if(!BX.SocNetLogDestination.isOpenSearch()&&BX("event-planner-dest-input").value.length>0){BX.style(BX("event-planner-dest-input-box"),"display","none");BX.style(BX("event-planner-dest-add-link"),"display","inline-block");BX("event-planner-dest-input").value="";BxPlannerDisableBackspace()}};e.BxPlannerDisableBackspace=function(t){if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!=null)BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(e,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode==8){BX.PreventDefault(e);return false}});setTimeout(function(){BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)};e.BxPlannerSearchBefore=function(e){return BX.SocNetLogDestination.searchBeforeHandler(e,{formName:plannerDestFormName,inputId:"event-planner-dest-input"})};e.BxPlannerSearch=function(e){return BX.SocNetLogDestination.searchHandler(e,{formName:plannerDestFormName,inputId:"event-planner-dest-input",linkId:"event-planner-dest-add-link",sendAjax:true})};e.ECPlanner=t})(window);
//# sourceMappingURL=cal-planner.map.js